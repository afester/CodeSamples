<!DOCTYPE html>

<!--
<?xml version="1.0" encoding="ISO-8859-1" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
-->

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
      <title>JavaScript samples</title>
  </head>

  <body onload="initialize();">
  
    <script>
    function getFormula() {
    	var result = formula.value;

    	result = result.replace("sin", "Math.sin");
    	result = result.replace("cos", "Math.cos");
    	result = result.replace("tan", "Math.tan");

    	return result;
    }

    function updateValues() {
    	var xRange = toX.value - fromX.value;
    	startY = -(xRange * 460) / (2 * 620);
    	stopY = -startY;

    	fromY.childNodes[0].data = Math.round(startY * 100) / 100;  // note: child node must exist!
    	toY.childNodes[0].data = Math.round(stopY * 100) / 100;     // note: child node must exist!

    	startX = parseFloat(fromX.value);
        stopX = toX.value;
        

        scalePerPixel = (stopX - startX) / 620;

        x0pos = -startX / scalePerPixel + 10;
        y0pos = -fromY.childNodes[0].data / scalePerPixel + 10;
    }


    function drawAxis() {
    	context.beginPath();
        context.strokeStyle = "black";
        context.lineWidth = 1;
        context.setLineDash(new Array());

        context.moveTo(x0pos, 0);
        context.lineTo(x0pos, 470);    // Y axis
        context.moveTo(10, y0pos);
        context.lineTo(630, y0pos);   // X axis

        // TODO:  Fix tick calculation!
        var mag = 620 / 20 * scalePerPixel;
        if (mag > 50) {
            tick = 1000;
        } else if (mag > 5) {
            tick = 100;
        } else if (mag > 0.5) {
            tick = 10;
        } else if (mag > 0.05) {
            tick = 1;
        } else if (mag > 0.005) {
            tick = 0.1;
        } else {
            alert("INVALID SCALE!")    // TODO ...
        }

        // alert(context.font);

        // draw the y scale
        for (var y = -tick; y > startY; y -= tick) {
        	ypos = y0pos - y / scalePerPixel;
        	context.moveTo(x0pos - 5, ypos); context.lineTo(x0pos + 5, ypos);

        	var value = Math.round(y * 10) / 10;
/*
        	var textMetrics = context.measureText(value);
        	var boxWidth = textMetrics.actualBoundingBoxLeft + textMetrics.actualBoundingBoxRight;
        	alert(textMetrics.actualBoundingBoxLeft + "," + textMetrics.actualBoundingBoxRight + "," +
        	      textMetrics.fontBoundingBoxAscent  +","+ textMetrics.fontBoundingBoxDescent + ","+
        	      textMetrics.width + "," + textMetrics.height);
        	var boxHeight = textMetrics.actualBoundingBoxAscent  + textMetrics.actualBoundingBoxDescent;
            context.strokeText(value, x0pos - boxWidth, ypos + boxHeight/2);
*/
        	context.strokeText(value, x0pos - 15, ypos + 3);
        }
        for (var y = tick; y < stopY; y += tick) {
            ypos = y0pos - y / scalePerPixel;
            context.moveTo(x0pos - 5, ypos); context.lineTo(x0pos + 5, ypos);

            var value = Math.round(y * 10) / 10;
            context.strokeText(value, x0pos - 15, ypos + 3);
        }

        // context.lineWidth = 0.5;
        // draw the x scale
        for (var x = -tick; x > startX; x -= tick) {
            xpos = x0pos + x / scalePerPixel;
            context.moveTo(xpos, y0pos - 5); context.lineTo(xpos, y0pos + 5);

            var value = Math.round(x * 10) / 10
            context.strokeText(value, xpos - 5, y0pos + 15);
        }
        for (var x = tick; x < stopX; x += tick) {
        	xpos = x0pos + x / scalePerPixel;
            context.moveTo(xpos, y0pos - 5); context.lineTo(xpos, y0pos + 5);

            var value = Math.round(x * 10) / 10
            context.strokeText(value, xpos - 5, y0pos + 15);
        }

        context.stroke();
    }

    function drawGraph(theGraph) {
    	context.beginPath();
    	context.strokeStyle = theGraph.color;
    	context.lineWidth = 1;
        context.setLineDash(new Array());

        // draw the graph
        var x = startX;
        y = eval(theGraph.formula);
        if (y == Infinity) {
            y = 1000;
        }
        xpos = x0pos + x / scalePerPixel;
        ypos = y0pos - y / scalePerPixel;
        context.moveTo(xpos, ypos);
        x += scalePerPixel;

        for (var x = startX + scalePerPixel;  x < stopX;  x += scalePerPixel) {
            y = eval(theGraph.formula);
    
            xpos = x0pos + x / scalePerPixel;
            ypos = y0pos - y / scalePerPixel;
    
            context.lineTo(xpos, ypos);
        }
        context.stroke();
    }

    function addGraph() {
    	
    	var graph = {
    			"formula" : getFormula(),
    			"color"   : graphColor.value 
    	}
    	graphs.push(graph);

        drawGraph(graph);
    }

    function reset() {
        updateValues();

        graphs = new Array();

        //canvas.width = canvas.width; // seems not to work on all browsers, see
        // http://stackoverflow.com/questions/2142535/how-to-clear-the-canvas-for-redrawing
        context.clearRect(0, 0, canvas.width, canvas.height);

        drawAxis();
    }

    function renderScene() {
        context.clearRect(0, 0, canvas.width, canvas.height);

        drawAxis();

        for (var i = 0; i < graphs.length; i++) {
            drawGraph(graphs[i]);
        }
    }

    function onMouseMove(evt) {
    	  mouseXpos = evt.clientX - canvas.offsetLeft;
    	  // ypos = evt.clientY - canvas.offsetTop;

    	  renderScene();
    	  context.beginPath();
    	  context.strokeStyle = "red";
    	  context.lineWidth = 0.5;
    	  context.setLineDash(new Array(8, 2));
    	  context.moveTo(mouseXpos, 0);
    	  context.lineTo(mouseXpos, 480);
    	  context.stroke();
    }

    function initialize() {
    	
    	// create global variables for the elements we want to access.
    	// Not all browsers support the global element variables, especially not
    	// in HTML5 mode.
        formula = document.getElementById("_formula");
        graphColor = document.getElementById("_graphColor");
        fromX = document.getElementById("_fromX");
        toX = document.getElementById("_toX");
        fromY = document.getElementById("_fromY");
        toY = document.getElementById("_toY");
        canvas = document.getElementById("_canvas"); 

        canvas.onmousemove = onMouseMove;
    	context = canvas.getContext('2d');
        context.font = '8pt arial,sans-serif';
    	reset();

        graphs = new Array();
    }

    </script>

    <table>

      <tr>
        <td><label>f(x) = </label><input id="_formula" value="2*sin(x)" /></td>
        <td><label>Color: </label><select id="_graphColor" name="graphColor">
                                     <option value="aqua">Aqua</option>
                                     <option value="black">Black</option>
                                     <option value="blue">Blue</option>
                                     <option value="fuchsia">Fuchsia</option>
                                     <option value="gray">Gray</option>
                                     <option value="green">Green</option>
                                     <option value="lime">Lime</option>
                                     <option value="maroon">Maroon</option>
                                     <option value="navy">Navy</option>
                                     <option value="olive">Olive</option>
                                     <option value="purple">Purple</option>
                                     <option value="red">Red</option>
                                     <option value="silver">Silver</option>
                                     <option value="teal">Teal</option>
                                     <option value="white">White</option>
                                     <option value="yellow">Yellow</option>
                                   </select></td>
        <td><button onclick="addGraph()">Add</button></td>
      </tr>

      <tr>
        <td><label>X axis: from: </label><input id="_fromX" value="-3.15" /></td>
        <td><label>to: </label><input id="_toX" value="6.3" /></td>
        <td><button onclick="reset()">Reset</button></td>
      </tr>

      <tr>    
        <td><label>Y axis: from: </label> <label id="_fromY">0</label></td>
        <td><label>to: </label> <label id="_toY">0</label></td>
      </tr>

    </table>

    <canvas id="_canvas" width="640" height="480" style="background:lightgray"></canvas> 
  </body>
</html>
