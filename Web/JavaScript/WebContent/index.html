<!DOCTYPE html>

<!--
<?xml version="1.0" encoding="ISO-8859-1" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
-->

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
      <link rel="stylesheet" type="text/css" href="functions.css">
      <title>JavaScript samples</title>
  </head>

  <body onload="initialize();">

    <script>
    
    // the global function graph view object
    var FGV = {}

    function getFormula() {
    	var result = FGV.formula.value;

    	result = result.replace("sin", "Math.sin");
    	result = result.replace("cos", "Math.cos");
    	result = result.replace("tan", "Math.tan");

    	return result;
    }

    function updateValues() {
    	var xRange = FGV.toX.value - FGV.fromX.value;
    	FGV.startY = -(xRange * 460) / (2 * 620);
    	FGV.stopY = -FGV.startY;

    	FGV.fromY.childNodes[0].data = Math.round(FGV.startY * 100) / 100;  // note: child node must exist!
    	FGV.toY.childNodes[0].data = Math.round(FGV.stopY * 100) / 100;     // note: child node must exist!

    	FGV.startX = parseFloat(FGV.fromX.value);
        FGV.stopX = parseFloat(FGV.toX.value);

        FGV.scalePerPixel = (FGV.stopX - FGV.startX) / 620;

        FGV.x0pos = -FGV.startX / FGV.scalePerPixel + 10;
        FGV.y0pos = -FGV.startY / FGV.scalePerPixel + 10;

        // TODO:  Fix tick calculation!
        var mag = 620 / 20 * FGV.scalePerPixel;
        if (mag > 50) {
            tick = 1000;
        } else if (mag > 5) {
            tick = 100;
        } else if (mag > 0.5) {
            tick = 10;
        } else if (mag > 0.05) {
            tick = 1;
        } else if (mag > 0.005) {
            tick = 0.1;
        } else {
            alert("INVALID SCALE!")    // TODO ...
        }
    }


    /**
     * Draws the axis including the ticks. 
     */
    function drawAxis() {
    	// set the axis visual properties
    	FGV.context.beginPath();
    	FGV.context.strokeStyle = "black";
    	FGV.context.lineWidth = 1;
    	FGV.context.setLineDash([]);

    	// draw the axis lines

    	// Y axis
    	FGV.context.moveTo(FGV.x0pos, 470);
    	FGV.context.lineTo(FGV.x0pos, 0);
        FGV.context.lineTo(FGV.x0pos - 5, 10);
        FGV.context.lineTo(FGV.x0pos + 5, 10);
        FGV.context.lineTo(FGV.x0pos, 0);
        FGV.context.strokeText("Y", FGV.x0pos - 15, 12);
    	
        // X axis
    	FGV.context.moveTo(10, FGV.y0pos);
    	FGV.context.lineTo(640, FGV.y0pos);
    	FGV.context.lineTo(630, FGV.y0pos - 5);
    	FGV.context.lineTo(630, FGV.y0pos + 5);
        FGV.context.lineTo(640, FGV.y0pos);
        FGV.context.strokeText("X", 630, FGV.y0pos + 20);

        // draw the y scale
        for (var y = -tick; y > FGV.startY; y -= tick) {
        	var ypos = FGV.y0pos - y / FGV.scalePerPixel;
        	FGV.context.moveTo(FGV.x0pos - 5, ypos); 
        	FGV.context.lineTo(FGV.x0pos + 5, ypos);

        	var value = Math.round(y * 10) / 10;
/*
        	var textMetrics = context.measureText(value);
        	var boxWidth = textMetrics.actualBoundingBoxLeft + textMetrics.actualBoundingBoxRight;
        	alert(textMetrics.actualBoundingBoxLeft + "," + textMetrics.actualBoundingBoxRight + "," +
        	      textMetrics.fontBoundingBoxAscent  +","+ textMetrics.fontBoundingBoxDescent + ","+
        	      textMetrics.width + "," + textMetrics.height);
        	var boxHeight = textMetrics.actualBoundingBoxAscent  + textMetrics.actualBoundingBoxDescent;
            context.strokeText(value, FGV.x0pos - boxWidth, ypos + boxHeight/2);
*/
            FGV.context.strokeText(value, FGV.x0pos - 15, ypos + 3);
        }
        for (var y = tick; y < FGV.stopY; y += tick) {
            var ypos = FGV.y0pos - y / FGV.scalePerPixel;
            FGV.context.moveTo(FGV.x0pos - 5, ypos); 
            FGV.context.lineTo(FGV.x0pos + 5, ypos);

            var value = Math.round(y * 10) / 10;
            FGV.context.strokeText(value, FGV.x0pos - 15, ypos + 3);
        }

        // draw the x scale
        for (var x = -tick; x > FGV.startX; x -= tick) {
            var xpos = FGV.x0pos + x / FGV.scalePerPixel;
            FGV.context.moveTo(xpos, FGV.y0pos - 5); 
            FGV.context.lineTo(xpos, FGV.y0pos + 5);

            var value = Math.round(x * 10) / 10
            FGV.context.strokeText(value, xpos - 5, FGV.y0pos + 15);
        }
        for (var x = tick; x < FGV.stopX; x += tick) {
        	var xpos = FGV.x0pos + x / FGV.scalePerPixel;
        	FGV.context.moveTo(xpos, FGV.y0pos - 5); 
        	FGV.context.lineTo(xpos, FGV.y0pos + 5);

            var value = Math.round(x * 10) / 10
            FGV.context.strokeText(value, xpos - 5, FGV.y0pos + 15);
        }

        FGV.context.fill(); // ????? Probably not quite  correct, but it works ...
        FGV.context.stroke();   // still required!!!!
    }

    /**
     * Draw all graphs which are currently defined.
     */
    function drawGraph(theGraph) {
    	FGV.context.beginPath();
    	FGV.context.strokeStyle = theGraph.color;
    	FGV.context.lineWidth = 1;
    	FGV.context.setLineDash([]);

        // draw the graph
        var x = FGV.startX;
        var y = eval(theGraph.formula);
        if (y == Infinity) {
            y = 1000;
        }

        var xpos = FGV.x0pos + x / FGV.scalePerPixel;
        var ypos = FGV.y0pos - y / FGV.scalePerPixel;
        FGV.context.moveTo(xpos, ypos);

        x += FGV.scalePerPixel;
        for (  ;  x < FGV.stopX;  x += FGV.scalePerPixel) {
            var y = eval(theGraph.formula);
    
            var xpos = FGV.x0pos + x / FGV.scalePerPixel;
            var ypos = FGV.y0pos - y / FGV.scalePerPixel;
            FGV.context.lineTo(xpos, ypos);
        }
        FGV.context.stroke();
    }


    function addGraph() {
    	
    	var graph = {
    			"formula" : getFormula(),
    			"color"   : FGV.graphColor.value 
    	}
    	FGV.graphs.push(graph);
        drawGraph(graph);
    }


    function reset() {
        updateValues();
        renderScene();
    }


    function clearDiagram() {
        FGV.graphs = new Array();
        renderScene();
    }


    function renderScene() {
        FGV.context.clearRect(0, 0, FGV.canvas.width, FGV.canvas.height);

        drawAxis();

        for (var i = 0; i < FGV.graphs.length; i++) {
            drawGraph(FGV.graphs[i]);
        }
    }


    function onMouseMove(evt) {
    	  var mouseXpos = evt.clientX - FGV.canvas.offsetLeft;
    	  var mouseYpos = evt.clientY - FGV.canvas.offsetTop;

    	  renderScene();

    	  // set visual properties for the cross
    	  FGV.context.beginPath();
    	  FGV.context.strokeStyle = "red";
    	  FGV.context.lineWidth = 0.5;
    	  FGV.context.setLineDash([8,2]);

    	  // draw the cross
    	  FGV.context.moveTo(mouseXpos, 0);
    	  FGV.context.lineTo(mouseXpos, 480);
    	  FGV.context.moveTo(0, mouseYpos);
    	  FGV.context.lineTo(640, mouseYpos);
    	  FGV.context.stroke();

    	  // update position values
    	  FGV.curXposNode.data = Math.round(((mouseXpos - FGV.x0pos) * FGV.scalePerPixel)*100)/100;
          FGV.curYposNode.data = Math.round(((FGV.y0pos - mouseYpos) * FGV.scalePerPixel)*100)/100;
    }
    

    function onMouseOut(evt) {
    	renderScene();
    }


    function initialize() {
    	// create global variables for the elements we want to access.
    	// Not all browsers support the global element variables, especially not
    	// in HTML5 mode.
        FGV.formula = document.getElementById("_formula");
        FGV.graphColor = document.getElementById("_graphColor");
        FGV.fromX = document.getElementById("_fromX");
        FGV.toX = document.getElementById("_toX");
        FGV.fromY = document.getElementById("_fromY");
        FGV.toY = document.getElementById("_toY");
        FGV.canvas = document.getElementById("_canvas"); 
        FGV.curXposNode = document.getElementById("_curXpos").childNodes[0];
        FGV.curYposNode = document.getElementById("_curYpos").childNodes[0];

        
        FGV.canvas.onmousemove = onMouseMove;
        FGV.canvas.onmouseout = onMouseOut;
        FGV.context = FGV.canvas.getContext('2d');
        FGV.context.font = '8pt arial,sans-serif';

        // Not all browsers support setLineDash!
        // http://www.rgraph.net/blog/2013/january/html5-canvas-dashed-lines.html
        if (!FGV.context.setLineDash) {
            FGV.context.setLineDash = function () {}
        }
        
        FGV.graphs = new Array();
    	reset();
    }

    </script>

    <table>

      <tr>
        <!--  <td><label>f(x) = </label><input id="_formula" value="2*sin(x)" /></td> -->
        <td><label>f(x) = </label><input id="_formula" value="x + 3*Math.pow(x,2) + Math.pow(x, 3) - 1" /></td>
        <td><label>Color: </label><select id="_graphColor" name="graphColor">
                                     <option value="aqua">Aqua</option>
                                     <option value="black">Black</option>
                                     <option value="blue">Blue</option>
                                     <option value="fuchsia">Fuchsia</option>
                                     <option value="gray">Gray</option>
                                     <option value="green">Green</option>
                                     <option value="lime">Lime</option>
                                     <option value="maroon">Maroon</option>
                                     <option value="navy">Navy</option>
                                     <option value="olive">Olive</option>
                                     <option value="purple">Purple</option>
                                     <option value="red">Red</option>
                                     <option value="silver">Silver</option>
                                     <option value="teal">Teal</option>
                                     <option value="white">White</option>
                                     <option value="yellow">Yellow</option>
                                   </select></td>
        <td><button onclick="addGraph()">Add</button></td>
        <td><button onclick="clearDiagram()">Clear</button></td>
      </tr>

      <tr>
        <td><label>X axis: from: </label><input id="_fromX" value="-3.15" /></td>
        <td><label>to: </label>          <input id="_toX" value="6.3" /></td>
        <td><button onclick="reset()">Apply</button></td>
      </tr>

      <tr>    
        <td><label>Y axis: from: </label> <label id="_fromY">0</label></td>
        <td><label>to: </label> <label id="_toY">0</label></td>
      </tr>

    </table>

    <div id="_graph">
        <canvas id="_canvas" width="640" height="480"></canvas>
    </div>

    <div id="_legend">
      <table>
        <tr><td>sqrt(x)</td><td><select id="_graphColor2" name="graphColor2"></select></td></tr>
        <tr><td>sqrt(x)</td><td><select id="_graphColor2" name="graphColor2"></select></td></tr>
        <tr><td>sqrt(x)</td><td><select id="_graphColor2" name="graphColor2"></select></td></tr>
        <tr><td>sqrt(x)</td><td><select id="_graphColor2" name="graphColor2"></select></td></tr>
      </table>
    </div>

    <p>
        <label>X:</label> <label id="_curXpos">0</label>
        <label>Y: </label> <label id="_curYpos">0</label>
    </p>
  </body>
</html>
